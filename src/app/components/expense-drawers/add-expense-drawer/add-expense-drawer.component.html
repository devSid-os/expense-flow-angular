<!-- ADD EXPENSE DRAWER -->
<p-drawer (onHide)='closeDrawer();' position='right' [visible]='isDrawerOpen()' [closable]='false'
    id='addExpenseDrawer'>
    <div class="w-full h-full flex flex-col bg-gray-50">
        <!-- Header -->
        <div class='p-4 bg-white border-b border-gray-200'>
            <div class='flex items-center justify-between'>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gray-900 text-white flex items-center justify-center">
                        <i class="fa-solid fa-receipt text-sm"></i>
                    </div>
                    <h2 class='text-lg font-semibold text-gray-900'>Create Expense</h2>
                </div>
                <button (click)='closeDrawer()' type='button'
                    class='w-8 h-8 rounded-full hover:bg-gray-100 text-gray-600 transition-colors'>
                    <i class='fa-solid fa-xmark'></i>
                </button>
            </div>
        </div>

        <!-- Form Content -->
        <form class='flex-1 overflow-y-auto' (ngSubmit)='createExpenseEntry()' [formGroup]='entryForm'>
            <div class="p-4 space-y-4">

                <!-- Date and Mode Row -->
                <div class='grid grid-cols-2 gap-3'>
                    <!-- Date Input -->
                    <div class='flex flex-col gap-1.5'>
                        <label class='text-sm font-medium text-gray-700'>Date</label>
                        <p-datepicker formControlName='date' [maxDate]='today' [iconDisplay]='"input"' [showIcon]='true'
                            inputId='icondisplay' />
                    </div>

                    <!-- Mode Select -->
                    <div class='flex flex-col gap-1.5'>
                        <label class='text-sm font-medium text-gray-700'>Payment Mode</label>
                        <p-select formControlName='mode' [options]='modeOptions' placeholder='Select mode'
                            [editable]='false' optionLabel='label' optionValue='value' styleClass="w-full" />
                    </div>
                </div>

                <div class="add-exp-autoc flex-row items-center">
                    <p-autocomplete 
                        [ngModelOptions]="{ standalone: true }"
                        placeholder="Search Recipient"
                        optionLabel="name"
                        [ngStyle]="{width: '100%'}"
                        [(ngModel)]="selectedRecipient" 
                        [suggestions]="recipients" 
                        (completeMethod)="searchReipients($event)" 
                        optionValue="_id"
                    />
                </div>

                <!-- Category Section -->
                <div class='bg-white border border-gray-200 rounded-lg p-4 space-y-3'>
                    <div class='flex items-center gap-2'>
                        <i class='fa-solid fa-layer-group text-gray-500 text-sm'></i>
                        <p class='text-sm font-semibold text-gray-900'>Category</p>
                    </div>

                    <p-select formControlName='category' [options]='categoriesOptions()' placeholder='Select a category'
                        [editable]='true' optionLabel='name' optionValue='name' styleClass='w-full' />

                    <!-- Category Actions -->
                    <div *ngIf='!isAddNewCategory && !isEditCategory' class='flex gap-2 pt-2 border-t border-gray-100 mt-3'>
                        <button (click)='showAddNewCategoryForm();' type='button'
                            class='flex-1 text-xs font-medium py-2 px-3 text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors'>
                            <i class='fa-solid fa-plus mr-1'></i>Add Category
                        </button>
                        <button (click)='isEditCategory = true;' type='button'
                            class='flex-1 text-xs font-medium py-2 px-3 text-gray-700 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors'>
                            <i class='fa-solid fa-pencil mr-1'></i>Edit
                        </button>
                    </div>

                    <!-- Add New Category Form -->
                    <app-add-category *ngIf='isAddNewCategory' (onCloseCategoryForm)='isAddNewCategory=false;'>
                    </app-add-category>

                    <!-- Edit Category Form -->
                    <app-edit-category-list *ngIf='isEditCategory' (onEditCategoryClick)='showEditCategoryModal($event)'
                        (onCloseEditCategoryModal)='isEditCategory=false;'>
                    </app-edit-category-list>
                </div>

                <!-- Expense Items Section -->
                <div class='bg-white border border-gray-200 rounded-lg p-4 space-y-3'>
                    <p class='text-sm font-semibold text-gray-900'>Expense Items</p>

                    <!-- Items List -->
                    <div class='space-y-2' *ngIf='cartItemsArray().length > 0'>
                        <div *ngFor='let item of cartItemsArray()'
                            class='flex justify-between items-start p-3 bg-gray-50 rounded-lg'>
                            <div>
                                <p class='text-sm font-medium text-gray-900'>{{item.item.name}}</p>
                                <p class='text-xs text-gray-500 mt-1 flex items-center gap-2'>
                                    <span>{{item.qty}}</span>
                                    <span>Ã—</span>
                                    <span>
                                        <i class='fa-solid fa-indian-rupee-sign text-[10px]'></i>{{item.item.price}}
                                    </span>
                                </p>
                            </div>
                            <p class='text-sm font-semibold text-gray-900'>
                                <i
                                    class='fa-solid fa-indian-rupee-sign text-xs'></i>{{calculateItemsTotal(item.item.price,
                                item.qty)}}
                            </p>
                        </div>
                    </div>

                    <!-- Add Items Button -->
                    <button (click)='openExpenseItemsDrawer();' type='button'
                        class='w-full p-3 text-sm font-medium text-gray-700 bg-white border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-colors'>
                        <i class='fa-solid fa-plus mr-2'></i>
                        {{cartItemsArray().length > 0 ? 'Add More Items' : 'Select Expense Items'}}
                    </button>
                </div>

                <!-- Total Amount -->
                <div class='flex flex-col gap-1.5' *ngIf='cartItemsArray().length'>
                    <label class='text-sm font-medium text-gray-900'>Total Amount</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                        <p class="text-sm font-bold text-gray-900">
                            <i class='fa-solid fa-indian-rupee-sign text-xs'></i>{{cartTotal()}}
                        </p>
                    </div>
                </div>

                <!-- Description Input -->
                <div class='flex flex-col gap-1.5'>
                    <label class='text-sm font-medium text-gray-700'>
                        Description <span class="text-gray-400 font-normal">(Optional)</span>
                    </label>
                    <input autocomplete='off' placeholder='Add a description...' pInputText type='text'
                        formControlName='description' class="w-full" />
                </div>

                <!-- Attachment Section -->
                <div class='flex flex-col gap-2'>
                    <label class='text-sm font-medium text-gray-700'>
                        Attachment <span class="text-gray-400 font-normal">(Optional)</span>
                    </label>

                    <ng-container *ngIf='uploadedFileUrl()'>
                        <app-form-image-preview [fileUrl]='uploadedFileUrl()' (removeFileUrl)='removeMediaUrl()'>
                        </app-form-image-preview>
                    </ng-container>

                    <button (click)='onUploadFileClick()' type='button'
                        class='w-full p-3 text-sm font-medium text-gray-700 bg-white border-2 border-dashed border-gray-300 rounded-lg hover:border-gray-400 hover:bg-gray-50 transition-colors'>
                        <i class='fa-solid fa-paperclip mr-2'></i>Attach Bill or Receipt
                    </button>
                </div>
            </div>

            <!-- Footer with Save Button -->
            <div class='p-4 bg-white border-t border-gray-200 mt-auto'>
                <button type='submit'
                    class='w-full rounded-lg text-sm py-3 font-semibold text-white bg-gray-900 hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed'
                    [disabled]='entryForm.invalid || cartItemsArray().length === 0'>
                    <i class="fa-solid fa-check mr-2"></i>Save Expense
                </button>
            </div>
        </form>
    </div>
</p-drawer>

<!-- EDIT CATEGORY FORM DIALOG -->
<app-edit-category-form *ngIf='editCategoryData' [editCategoryData]='editCategoryData'
    [showEditCategoryDialog]='showEditCategoryDialog' (onCloseEditCategoryDialog)='closeEditCategoryModal()'>
</app-edit-category-form>

<p-toast position='bottom-center' />